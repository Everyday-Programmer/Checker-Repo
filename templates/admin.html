<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            background-color: #1e1f22;
            color: #f0f0f0;
        }
        header {
            padding: 20px;
            display: flex;
            height: 20px;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
        }
        header a {
            color: #000;
            text-decoration: none;
        }
        .top-nav {
            display: flex;
            align-items: center;
        }
        .top-nav a + a {
            margin-left: 20px;
        }
        .main {
            flex: 1;
            display: grid;
            grid-template-columns: 20vw 80vw;
        }
        .aside {
            padding: 20px;
        }
        .aside h2 {
            margin-top: 0;
        }
        .aside ul {
            margin-top: 20px;
            padding: 0;
            list-style: none;
        }
        .aside li {
            margin-bottom: 10px;
        }
        .aside dl {
            width: 100%;
        }
        .aside li a, .aside dl a {
            color: #f0f0f0;
            text-decoration: none;
        }
        .content {
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .content h2 {
            margin-top: 0;
        }
        .content .stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .content .stats .period {
            display: flex;
            align-items: center;
        }
        .content .stats .period button {
            background-color: transparent;
            border: none;
            color: inherit;
            margin-left: 10px;
            cursor: pointer;
        }
        .content .ratings {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .content .ratings .rating {
            text-align: center;
        }
        .content .ratings .rating h3 {
            margin-top: 0;
        }
        main div aside ul li p {
            font-size: medium;
        }
        main div aside ul li p.active {
            color: #1e69e1;
            text-decoration: none;
        }
        #IPList li {
            background-color: #1e69e1;
            list-style-type: none;
            border-radius: 16px;
            padding: 1px;
            margin: 10px;
        }
        #DomainList li {
            background-color: #1e69e1;
            list-style-type: none;
            border-radius: 16px;
            padding: 1px;
            margin: 10px;
        }
        #UrlList li {
            background-color: #1e69e1;
            list-style-type: none;
            border-radius: 16px;
            padding: 1px;
            margin: 10px;
        }
        #IPList h3 {
            margin: 10px 10px 6px;
        }
        #IPList form {
            margin-left: 10px;
            margin-bottom: 6px;
        }
        #IPList h5 {
            margin: 0 0 6px 10px;
        }
        #IPList form input[type=submit] {
            padding:5px 15px; 
            background:#fa4646; 
            border:0 none;
            cursor:pointer;
            -webkit-border-radius: 5px;
            border-radius: 5px; 
            color: #f0f0f0;
            font-size: 14px;
            font-family: sans-serif;
            font-weight: bold;
        }
        #IPList form input[type=submit]:hover {
            background:#f0f0f0;
            cursor:pointer;
            color: #fa4646;
        }
        #DomainList h3 {
            margin: 10px 10px 6px;
        }
        #DomainList form {
            margin-left: 10px;
            margin-bottom: 6px;
        }
        #DomainList h5 {
            margin: 0 0 6px 10px;
        }
        #DomainList form input[type=submit] {
            padding:5px 15px; 
            background:#fa4646; 
            border:0 none;
            cursor:pointer;
            -webkit-border-radius: 5px;
            border-radius: 5px; 
            color: #f0f0f0;
            font-size: 14px;
            font-family: sans-serif;
            font-weight: bold;
        }
        #DomainList form input[type=submit]:hover {
            background:#f0f0f0;
            cursor:pointer;
            color: #fa4646;
        }
        #UrlList h3 {
            margin: 10px 10px 6px;
        }
        #UrlList h5 {
            margin: 0 0 6px 10px;
        }
        #UrlList form {
            margin-left: 10px;
            margin-bottom: 6px;
        }
        #UrlList form input[type=submit] {
            padding:5px 15px; 
            background:#fa4646; 
            border:0 none;
            cursor:pointer;
            -webkit-border-radius: 5px;
            border-radius: 5px; 
            color: #f0f0f0;
            font-size: 14px;
            font-family: sans-serif;
            font-weight: bold;
        }
        #UrlList form input[type=submit]:hover {
            background:#f0f0f0;
            cursor:pointer;
            color: #fa4646;
        }
        #rightPanel {
            border-bottom-left-radius: 16px;
            border-top-left-radius: 16px;
            border: 1px none #ccc;
            border-left-style: solid;
            height: fit-content;
            min-height: 100vh;
        }
        label {
            color: #f0f0f0;
            font-family: Calibri,sans-serif;
            font-size: large;
        }
        #rightPanel input{
            width: 100%;
            height: 38px;
            border-radius: 10px;
            border: 1px solid #f0f0f0;
            box-sizing: border-box;
            padding: 8px;
            font-family: Calibri,sans-serif;
        }
        #rightPanel select {
            width: 100%;
            height: 38px;
            border-radius: 10px;
            border: 1px solid #f0f0f0;
            box-sizing: border-box;
            padding: 8px;
        }
        #rightPanel option {
            width: 100%;
            height: 38px;
            padding: 8px;
            font-size: medium;
            font-family: Calibri,sans-serif;
        }
        #rightPanel input[type="submit"] {
            background-color: #1e69e1;
            width: 100%;
            display: block;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            text-align: center;
            cursor: pointer;
            font-size: medium;
        }
        #rightPanel input[type="submit"]:hover {
            background-color: #f0f0f0;
            color: #1e69e1;
        }
        #rightPanel input[type="file"] {
            height: 38px;
            font-size: medium;
            border: none;
            color: #f0f0f0;
        }
        #APIGenerate input[type="text"]{
            width: 40%;
            height: 38px;
            border-radius: 10px;
            border: 1px solid #f0f0f0;
            box-sizing: border-box;
            padding: 8px;
            font-family: Calibri,sans-serif;
            font-size: large;
        }
        #APIGenerate input[type="submit"], input[type="button"], button {
            background-color: #1e69e1;
            width: fit-content;
            height: 40px;
            display: block;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            color: white;
            text-align: center;
            cursor: pointer;
            font-size: medium;
            margin: auto;
            padding: 12px;
        }
        #APIGenerate input[type="submit"]:hover, input[type="button"]:hover, button:hover {
            background-color: #f0f0f0;
            color: #1e69e1;
        }
        #APIGenerate input[type="button"][disabled] {
            background-color: rgba(113, 121, 124, 0.1);
            color: white;
        }
        #APIGenerate input[type="button"][disabled]:hover {
            background-color: rgba(113, 121, 124, 0.1);
            color: white;
        }
        #Settings input[type=checkbox]{
            height: 0;
            width: 0;
            visibility: hidden;
            margin: 0;
            padding: 0;
            border: 0;
        }

        #Settings .switchLabel {
            cursor: pointer;
            width: 36px;
            height: 20px;
            background: grey;
            display: block;
            border-radius: 100px;
            position: relative;
        }

        #Settings .switchLabel:after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 90px;
            transition: 0.3s;
        }

        #Settings input:checked + .switchLabel {
            background: #1e69e1;
        }

        #Settings input:checked + .switchLabel:after {
            left: calc(100% - 5px);
            transform: translateX(-100%);
        }

        #Settings .switchLabel:active:after {
            width: 30px;
        }
    </style>
</head>
<body>
    <main class="main">
        <div style="width: 100%; background-color: #2b2d30; border: 0 solid #ccc; border-bottom-right-radius: 20px; border-top-right-radius: 20px; ">
            <aside class="aside" style="height: 90vh; width: max-content; position: fixed; z-index: 1">
                <h2 style="color: #1e69e1;">Navigation</h2>
                <ul>
                    <li><p style="cursor: pointer;" class="active" id="showIPList">IP List ({{ ip_urls | length }})</p></li>
                    <li><p style="cursor: pointer;" id="showDomainList">Domain List ({{ domain_urls | length }})</p></li>
                    <li><p style="cursor: pointer;" id="showUrlList">Urls List ({{ url_urls | length }})</p></li>
                    <li><p style="cursor: pointer;" id="showGenerateAPI">Generate API Key</p></li>
                    <li><p style="cursor: pointer;" id="showSettings">Update Preference</p></li>
                </ul>
            </aside>
        </div>
        <div style="display: grid; grid-template-columns: 55vw 22vw; grid-gap: 20px; flex: 1">
            <div>
                <header>
                    <h1>IOC Checker</h1>
                    <h5 style="font-family: Calibri,sans-serif;">Last updated: {{ last_updated }}</h5>
                </header>
                <div id="IPList">
                    <h3 style="width: 100%; text-align: center;">IP URLs List</h3>
                    <ul>
                        {% for label, url in ip_urls.items() %}
                        <li>
                            <h3>{{ label }}</h3><h5>{{ url }}</h5>
                                <form action="/admin/delete_url?opt=ip" method="post" style="display: inline-block;">
                                    <input type="hidden" name="label" value="{{ label }}">
                                    <input type="hidden" name="username" value="admin">
                                    <input type="hidden" name="password" value="password">
                                    <input style="cursor: pointer;" type="submit" value="Delete">
                                </form>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div id="DomainList" style="display: none;">
                    <h3 style="width: 100%; text-align: center;">Domain URLs List</h3>
                    <ul>
                        {% for label, url in domain_urls.items() %}
                        <li>
                            <h3>{{ label }}</h3><h5>{{ url }}</h5>
                            <form action="/admin/delete_url?opt=domain" method="post" style="display: inline-block;">
                                <input type="hidden" name="label" value="{{ label }}">
                                <input type="hidden" name="username" value="admin">
                                <input type="hidden" name="password" value="password">
                                <input style="cursor: pointer;" type="submit" value="Delete">
                            </form>
                        </li>
                    {% endfor %}
                    </ul>
                </div>
                <div id="UrlList" style="display: none;">
                    <h3 style="width: 100%; text-align: center;">URLs List</h3>
                    <ul>
                        {% for label, url in url_urls.items() %}
                        <li>
                            <h3>{{ label }}</h3><h5>{{ url }}</h5>
                            <form action="/admin/delete_url?opt=url" method="post" style="display: inline-block;">
                                <input type="hidden" name="label" value="{{ label }}">
                                <input type="hidden" name="username" value="admin">
                                <input type="hidden" name="password" value="password">
                                <input style="cursor: pointer;" type="submit" value="Delete">
                            </form>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div id="APIGenerate" style="display: none;">
                    <h3 style="width: 100%; text-align: center;">Generate API Key</h3>
                    <div style="text-align: center;">
                        <label for="apiKey">API Key:</label><br>
                        <input type="text" id="apiKey" readonly value="{{ api_key }}"><br><br>
                        <div style="width: 40%; display: grid; grid-template-columns: 50% 50%; margin: auto;">
                            <input type="submit" id="generateAPI" value="Generate API">
                            <input type="button" id="copyAPI" value="Copy API Key" disabled>
                        </div>
                        <p id="apiCopied" style="display: none; color: chartreuse;">API Key copied to clipboard!</p>
                    </div>
                </div>
                <div id="Settings" style="display: none;">
                    <h3 style="width: 100%; text-align: center;">Update Preference</h3>
                    <div style="width: 90%; display: grid; grid-template-columns: 50% 50%; padding: 10px; justify-content: space-between; align-items: center; margin: auto;">
                        <div style="text-align: center; margin-top: 16px">
                            <p>Update database automatically</p>
                        </div>
                        <div style="text-align: center; margin: auto">
                            <input type="checkbox" id="enableAutomaticUpdate" />
                            <label class="switchLabel" for="enableAutomaticUpdate"></label>
                        </div>
                    </div>
                    <div style="width: 90%; display: grid; grid-template-columns: 50% 50%; margin: auto; text-align: center">
                        <label for="updateInterval">Database update interval in hours</label>
                        <input style="width: 50%;" type="number" id="updateInterval" name="updateInterval" value="{{ update_interval }}">
                    </div>
                    <div style="width: 50%; display: grid; grid-template-columns: 50% 50%; grid-gap: 10px; margin: auto">
                        <button style="margin-top: 30px;" id="updateDatabase">Update Database Now</button>
                        <button style="margin-top: 30px; width: 100px;" id="saveSettings">Save</button>
                    </div>
                </div>
            </div>
            <div id="rightPanel">
                <aside class="aside">
                    <h2 style="text-align: center;">Add new data source to database</h2>
                    <h4 style="text-align: center;">Add URL</h4>
                    <form action="/admin/add_url" method="post">
                        <label for="label">Label</label><br>
                        <input type="text" id="label" name="label" required><br><br>
                        <label for="url">URL</label><br>
                        <input type="url" id="url" name="url" required><br><br>
                        <input type="hidden" name="username" value="admin">
                        <input type="hidden" name="password" value="password">
                        <label for="add_to">Add to</label><br>
                        <select id="add_to" name="add_to">
                            <option value="IP Address">IP Address</option>
                            <option value="Domain">Domain</option>
                            <option value="URL">URL</option>
                        </select><br><br>
                        <input type="submit" value="Add URL">
                    </form>
                    <br>
                    <hr>
                    <h3 style="text-align: center;">Upload a Text File</h3>
                    <form method="post" action="/upload" enctype="multipart/form-data">
                        <input type="file" name="file" required><br><br>
                        <label for="source">Source</label>
                        <input type="text" name="source" id="source" required><br><br>
                        <label for="upload_to">Upload to</label><br>
                        <select id="upload_to" name="upload_to">
                            <option value="IP Address">IP Address</option>
                            <option value="Domain">Domain</option>
                            <option value="URL">URL</option>
                        </select><br><br>
                        <input type="submit" value="Upload">
                    </form>
                    <p style="color: chartreuse; text-align: center;" id="successText">Added successfully!</p>
                </aside>
            </div>
            </div>
        </main>
        <script>
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            const s = params.get('s');

            console.log("{{ api_key }}")

            if (s === "success") {
                document.getElementById("successText").style.display = "block";
            } else {
                document.getElementById("successText").style.display = "none";
            }
            document.getElementById("showIPList").onclick = function() {
                document.getElementById("IPList").style.display = "block";
                document.getElementById("DomainList").style.display = "none";
                document.getElementById("UrlList").style.display = "none";
                document.getElementById("Settings").style.display = "none";
                document.getElementById("APIGenerate").style.display = "none";
                document.getElementById("showIPList").classList.add("active");
                document.getElementById("showDomainList").classList.remove("active");
                document.getElementById("showUrlList").classList.remove("active");
                document.getElementById("showGenerateAPI").classList.remove("active");
                document.getElementById("showSettings").classList.remove("active");
            }

            document.getElementById("showDomainList").onclick = function() {
                document.getElementById("DomainList").style.display = "block";
                document.getElementById("IPList").style.display = "none";
                document.getElementById("UrlList").style.display = "none";
                document.getElementById("APIGenerate").style.display = "none";
                document.getElementById("showDomainList").classList.add("active");
                document.getElementById("Settings").style.display = "none";
                document.getElementById("showIPList").classList.remove("active");
                document.getElementById("showUrlList").classList.remove("active");
                document.getElementById("showGenerateAPI").classList.remove("active");
                document.getElementById("showSettings").classList.remove("active");
            }

            document.getElementById("showUrlList").onclick = function() {
                document.getElementById("UrlList").style.display = "block";
                document.getElementById("IPList").style.display = "none";
                document.getElementById("APIGenerate").style.display = "none";
                document.getElementById("DomainList").style.display = "none";
                document.getElementById("Settings").style.display = "none";
                document.getElementById("showUrlList").classList.add("active");
                document.getElementById("showIPList").classList.remove("active");
                document.getElementById("showDomainList").classList.remove("active");
                document.getElementById("showGenerateAPI").classList.remove("active");
                document.getElementById("showSettings").classList.remove("active");
            }

            document.getElementById("showGenerateAPI").onclick = function() {
                document.getElementById("APIGenerate").style.display = "block";
                document.getElementById("UrlList").style.display = "none";
                document.getElementById("IPList").style.display = "none";
                document.getElementById("DomainList").style.display = "none";
                document.getElementById("Settings").style.display = "none";
                document.getElementById("showGenerateAPI").classList.add("active");
                document.getElementById("showUrlList").classList.remove("active");
                document.getElementById("showIPList").classList.remove("active");
                document.getElementById("showDomainList").classList.remove("active");
                document.getElementById("showSettings").classList.remove("active");
            }

            document.getElementById("showSettings").onclick = function() {
                document.getElementById("Settings").style.display = "block";
                document.getElementById("IPList").style.display = "none";
                document.getElementById("DomainList").style.display = "none";
                document.getElementById("UrlList").style.display = "none";
                document.getElementById("APIGenerate").style.display = "none";
                document.getElementById("showSettings").classList.add("active");
                document.getElementById("showIPList").classList.remove("active");
                document.getElementById("showDomainList").classList.remove("active");
                document.getElementById("showUrlList").classList.remove("active");
                document.getElementById("showGenerateAPI").classList.remove("active");
            }

            document.getElementById("generateAPI").onclick = function() {
                generateApiKey();
            }

            document.getElementById("copyAPI").onclick = function () {
                copyToClipboard()
            }

            document.getElementById("saveSettings").onclick = function () {
                updateSettings();
            }

            document.getElementById("updateDatabase").onclick = function () {
                updateNow();
            }

            const automatic_update = "{{ automatic_update }}";
            console.log(automatic_update)
            document.getElementById("enableAutomaticUpdate").checked = automatic_update === "True";

            async function updateNow() {
                try {
                    const response = await fetch('/update_now', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({

                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to send update request');
                    }

                    const result = await response.json();
                    console.log('Database updated!');
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            async function updateSettings() {
                const automaticUpdate = document.getElementById("enableAutomaticUpdate").checked;
                const interval = parseInt(document.getElementById("updateInterval").value);
                try {
                    const response = await fetch('/update_settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            enable_automatic_update: automaticUpdate,
                            update_interval: interval
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save Settings');
                    }

                    const result = await response.json();
                    console.log('Settings updated!');
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            document.addEventListener('DOMContentLoaded', () => {
                const storedUsername = localStorage.getItem('username');
                const storedPassword = localStorage.getItem('password');

                if (storedUsername !== "admin" && storedPassword !== "password") {
                    window.location = "login";
                }
            });

            function generateApiKey() {
                const apiKeyLength = 16;
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let apiKey = '';

                for (let i = 0; i < apiKeyLength; i++) {
                    const randomIndex = Math.floor(Math.random() * characters.length);
                    apiKey += characters[randomIndex];
                }

                document.getElementById('apiKey').value = apiKey;
                sendApiKey(apiKey, "admin");
            }

            async function copyToClipboard() {
                const apiKey = document.getElementById('apiKey').value;

                try {
                    await navigator.clipboard.writeText(apiKey);
                    document.getElementById('apiCopied').style.display = "block";
                } catch (err) {
                    console.error('Failed to copy: ', err);
                }
            }

            async function sendApiKey(apiKey, userId) {
                try {
                    const response = await fetch('/api_generated', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            api_key: apiKey,
                            user_id: userId
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to save API key');
                    }

                    const result = await response.json();
                    console.log('API key saved with ID:', result.id);
                    document.getElementById("copyAPI").disabled = false;
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        </script>
    </body>
</html>